<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Kubernetes源码阅读—kubectl(一) · Arthur</title><meta name="description" content="Kubernetes源码阅读—kubectl(一) - Bin Xu"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://xizie.com/atom.xml" title="Arthur"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/xubinlife" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Kubernetes源码阅读—kubectl(一)</h1><div class="post-info">Feb 25, 2019</div><div class="post-content"><p>Kubectl依赖于cobra包构建命令行支持，该包是支持通用的命令行构建库。</p>
<h1 id="Kubectl流程分析"><a href="#Kubectl流程分析" class="headerlink" title="Kubectl流程分析"></a>Kubectl流程分析</h1><p>大致工作流程为：</p>
<ul>
<li>用户发起请求  </li>
<li>根据用户执行的动作，分发给处理对应动作的Cmd</li>
<li>解析用户命令</li>
<li>向ApiServer获取数据</li>
<li>整理返回为通用的数据集合</li>
<li>找到解释查询数据的句柄</li>
<li>使用句柄对整理出的数据集合进行打印输出</li>
</ul>
<p>以<code>kubectl describe node node1</code>为例：</p>
<h2 id="func-main"><a href="#func-main" class="headerlink" title="func main()"></a><code>func main()</code></h2><p><a href="https://github.com/kubernetes/kubernetes/blob/v1.11.7/cmd/kubectl/kubectl.go#L36" target="_blank" rel="noopener"><code>kubernetes/cmd/kubectl/kubectl.go</code></a><br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    rand.Seed(time.Now().UTC().UnixNano())</span><br><span class="line"></span><br><span class="line">    command := cmd.NewDefaultKubectlCommand()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> once we switch everything over to Cobra commands, we can go back to calling</span></span><br><span class="line">    <span class="comment">// utilflag.InitFlags() (by removing its pflag.Parse() call). For now, we have to set the</span></span><br><span class="line">    <span class="comment">// normalize func and add the go flag set by hand.</span></span><br><span class="line">    pflag.CommandLine.SetNormalizeFunc(utilflag.WordSepNormalizeFunc)</span><br><span class="line">    pflag.CommandLine.AddGoFlagSet(goflag.CommandLine)</span><br><span class="line">    <span class="comment">// utilflag.InitFlags()</span></span><br><span class="line">    logs.InitLogs()</span><br><span class="line">    <span class="keyword">defer</span> logs.FlushLogs()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err := command.Execute(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Fprintf(os.Stderr, <span class="string">"%v\n"</span>, err)</span><br><span class="line">        os.Exit(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中，<code>NewDefaultKubectlCommand()</code>向cobra注册了kubectl的命令。</p>
<h2 id="func-NewDefaultKubectlCommand"><a href="#func-NewDefaultKubectlCommand" class="headerlink" title="func NewDefaultKubectlCommand()"></a><code>func NewDefaultKubectlCommand()</code></h2><p><a href="https://github.com/kubernetes/kubernetes/blob/v1.11.7/pkg/kubectl/cmd/cmd.go#L259" target="_blank" rel="noopener"><code>kubernetes/pkg/kubectl/cmd/cmd.go</code></a><br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDefaultKubectlCommand</span><span class="params">()</span> *<span class="title">cobra</span>.<span class="title">Command</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> NewKubectlCommand(os.Stdin, os.Stdout, os.Stderr)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="func-NewKubectlCommand-in-io-Reader-out-err-io-Writer"><a href="#func-NewKubectlCommand-in-io-Reader-out-err-io-Writer" class="headerlink" title="func NewKubectlCommand(in io.Reader, out, err io.Writer)"></a><code>func NewKubectlCommand(in io.Reader, out, err io.Writer)</code></h2><p><a href="https://github.com/kubernetes/kubernetes/blob/v1.11.7/pkg/kubectl/cmd/cmd.go#L264" target="_blank" rel="noopener"><code>kubernetes/pkg/kubectl/cmd/cmd.go</code></a><br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewKubectlCommand creates the `kubectl` command and its nested children.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewKubectlCommand</span><span class="params">(in io.Reader, out, err io.Writer)</span> *<span class="title">cobra</span>.<span class="title">Command</span></span> &#123;</span><br><span class="line">    <span class="comment">// Parent command to which all subcommands are added.</span></span><br><span class="line">    cmds := &amp;cobra.Command&#123;</span><br><span class="line">        Use:   <span class="string">"kubectl"</span>,</span><br><span class="line">        Short: i18n.T(<span class="string">"kubectl controls the Kubernetes cluster manager"</span>),</span><br><span class="line">        Long: templates.LongDesc(<span class="string">`</span></span><br><span class="line"><span class="string">      kubectl controls the Kubernetes cluster manager.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      Find more information at:</span></span><br><span class="line"><span class="string">            https://kubernetes.io/docs/reference/kubectl/overview/`</span>),</span><br><span class="line">        Run: runHelp,</span><br><span class="line">        BashCompletionFunction: bashCompletionFunc,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    flags := cmds.PersistentFlags()</span><br><span class="line">    flags.SetNormalizeFunc(utilflag.WarnWordSepNormalizeFunc) <span class="comment">// Warn for "_" flags</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Normalize all flags that are coming from other packages or pre-configurations</span></span><br><span class="line">    <span class="comment">// a.k.a. change all "_" to "-". e.g. glog package</span></span><br><span class="line">    flags.SetNormalizeFunc(utilflag.WordSepNormalizeFunc)</span><br><span class="line"></span><br><span class="line">    kubeConfigFlags := genericclioptions.NewConfigFlags()</span><br><span class="line">    kubeConfigFlags.AddFlags(flags)</span><br><span class="line">    matchVersionKubeConfigFlags := cmdutil.NewMatchVersionFlags(kubeConfigFlags)</span><br><span class="line">    matchVersionKubeConfigFlags.AddFlags(cmds.PersistentFlags())</span><br><span class="line"></span><br><span class="line">    cmds.PersistentFlags().AddGoFlagSet(flag.CommandLine)</span><br><span class="line"></span><br><span class="line">    f := cmdutil.NewFactory(matchVersionKubeConfigFlags)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sending in 'nil' for the getLanguageFn() results in using</span></span><br><span class="line">    <span class="comment">// the LANG environment variable.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Consider adding a flag or file preference for setting</span></span><br><span class="line">    <span class="comment">// the language, instead of just loading from the LANG env. variable.</span></span><br><span class="line">    i18n.LoadTranslations(<span class="string">"kubectl"</span>, <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// From this point and forward we get warnings on flags that contain "_" separators</span></span><br><span class="line">    cmds.SetGlobalNormalizationFunc(utilflag.WarnWordSepNormalizeFunc)</span><br><span class="line"></span><br><span class="line">    ioStreams := genericclioptions.IOStreams&#123;In: in, Out: out, ErrOut: err&#125;</span><br><span class="line"></span><br><span class="line">    groups := templates.CommandGroups&#123;</span><br><span class="line">        &#123;</span><br><span class="line">            Message: <span class="string">"Basic Commands (Beginner):"</span>,</span><br><span class="line">            Commands: []*cobra.Command&#123;</span><br><span class="line">                create.NewCmdCreate(f, ioStreams),</span><br><span class="line">                NewCmdExposeService(f, ioStreams),</span><br><span class="line">                NewCmdRun(f, ioStreams),</span><br><span class="line">                set.NewCmdSet(f, ioStreams),</span><br><span class="line">                deprecatedAlias(<span class="string">"run-container"</span>, NewCmdRun(f, ioStreams)),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            Message: <span class="string">"Basic Commands (Intermediate):"</span>,</span><br><span class="line">            Commands: []*cobra.Command&#123;</span><br><span class="line">                NewCmdExplain(<span class="string">"kubectl"</span>, f, ioStreams),</span><br><span class="line">                get.NewCmdGet(<span class="string">"kubectl"</span>, f, ioStreams),</span><br><span class="line">                NewCmdEdit(f, ioStreams),</span><br><span class="line">                NewCmdDelete(f, ioStreams),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            Message: <span class="string">"Deploy Commands:"</span>,</span><br><span class="line">            Commands: []*cobra.Command&#123;</span><br><span class="line">                rollout.NewCmdRollout(f, ioStreams),</span><br><span class="line">                NewCmdRollingUpdate(f, ioStreams),</span><br><span class="line">                NewCmdScale(f, ioStreams),</span><br><span class="line">                NewCmdAutoscale(f, ioStreams),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            Message: <span class="string">"Cluster Management Commands:"</span>,</span><br><span class="line">            Commands: []*cobra.Command&#123;</span><br><span class="line">                NewCmdCertificate(f, ioStreams),</span><br><span class="line">                NewCmdClusterInfo(f, ioStreams),</span><br><span class="line">                NewCmdTop(f, ioStreams),</span><br><span class="line">                NewCmdCordon(f, ioStreams),</span><br><span class="line">                NewCmdUncordon(f, ioStreams),</span><br><span class="line">                NewCmdDrain(f, ioStreams),</span><br><span class="line">                NewCmdTaint(f, ioStreams),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            Message: <span class="string">"Troubleshooting and Debugging Commands:"</span>,</span><br><span class="line">            Commands: []*cobra.Command&#123;</span><br><span class="line">                NewCmdDescribe(<span class="string">"kubectl"</span>, f, ioStreams),        <span class="comment">// 此处注册了describe的cmd</span></span><br><span class="line">                NewCmdLogs(f, ioStreams),</span><br><span class="line">                NewCmdAttach(f, ioStreams),</span><br><span class="line">                NewCmdExec(f, ioStreams),</span><br><span class="line">                NewCmdPortForward(f, ioStreams),</span><br><span class="line">                NewCmdProxy(f, ioStreams),</span><br><span class="line">                NewCmdCp(f, ioStreams),</span><br><span class="line">                auth.NewCmdAuth(f, ioStreams),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            Message: <span class="string">"Advanced Commands:"</span>,</span><br><span class="line">            Commands: []*cobra.Command&#123;</span><br><span class="line">                NewCmdApply(<span class="string">"kubectl"</span>, f, ioStreams),</span><br><span class="line">                NewCmdPatch(f, ioStreams),</span><br><span class="line">                NewCmdReplace(f, ioStreams),</span><br><span class="line">                wait.NewCmdWait(f, ioStreams),</span><br><span class="line">                NewCmdConvert(f, ioStreams),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            Message: <span class="string">"Settings Commands:"</span>,</span><br><span class="line">            Commands: []*cobra.Command&#123;</span><br><span class="line">                NewCmdLabel(f, ioStreams),</span><br><span class="line">                NewCmdAnnotate(<span class="string">"kubectl"</span>, f, ioStreams),</span><br><span class="line">                NewCmdCompletion(ioStreams.Out, <span class="string">""</span>),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    groups.Add(cmds)</span><br><span class="line"></span><br><span class="line">    filters := []<span class="keyword">string</span>&#123;<span class="string">"options"</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Hide the "alpha" subcommand if there are no alpha commands in this build.</span></span><br><span class="line">    alpha := NewCmdAlpha(f, ioStreams)</span><br><span class="line">    <span class="keyword">if</span> !alpha.HasSubCommands() &#123;</span><br><span class="line">        filters = <span class="built_in">append</span>(filters, alpha.Name())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    templates.ActsAsRootCommand(cmds, filters, groups...)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> name, completion := <span class="keyword">range</span> bash_completion_flags &#123;</span><br><span class="line">        <span class="keyword">if</span> cmds.Flag(name) != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> cmds.Flag(name).Annotations == <span class="literal">nil</span> &#123;</span><br><span class="line">                cmds.Flag(name).Annotations = <span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">string</span>&#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">            cmds.Flag(name).Annotations[cobra.BashCompCustom] = <span class="built_in">append</span>(</span><br><span class="line">                cmds.Flag(name).Annotations[cobra.BashCompCustom],</span><br><span class="line">                completion,</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cmds.AddCommand(alpha)</span><br><span class="line">    cmds.AddCommand(cmdconfig.NewCmdConfig(f, clientcmd.NewDefaultPathOptions(), ioStreams))</span><br><span class="line">    cmds.AddCommand(NewCmdPlugin(f, ioStreams))</span><br><span class="line">    cmds.AddCommand(NewCmdVersion(f, ioStreams))</span><br><span class="line">    cmds.AddCommand(NewCmdApiVersions(f, ioStreams))</span><br><span class="line">    cmds.AddCommand(NewCmdApiResources(f, ioStreams))</span><br><span class="line">    cmds.AddCommand(NewCmdOptions(ioStreams.Out))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cmds</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注册所有的cmd命令</p>
<p>[## <code>func NewCmdDescribe(parent string, f cmdutil.Factory, streams genericclioptions.IOStreams)</code><br><a href="https://github.com/kubernetes/kubernetes/blob/v1.11.7/pkg/kubectl/cmd/describe.go#L91" target="_blank" rel="noopener"><code>kubernetes/pkg/kubectl/cmd/describe.go</code></a><br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCmdDescribe</span><span class="params">(parent <span class="keyword">string</span>, f cmdutil.Factory, streams genericclioptions.IOStreams)</span> *<span class="title">cobra</span>.<span class="title">Command</span></span> &#123;</span><br><span class="line">    o := &amp;DescribeOptions&#123;</span><br><span class="line">        FilenameOptions: &amp;resource.FilenameOptions&#123;&#125;,</span><br><span class="line">        DescriberSettings: &amp;printers.DescriberSettings&#123;</span><br><span class="line">            ShowEvents: <span class="literal">true</span>,</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        CmdParent: parent,</span><br><span class="line"></span><br><span class="line">        IOStreams: streams,</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    cmd := &amp;cobra.Command&#123;</span><br><span class="line">        Use: <span class="string">"describe (-f FILENAME | TYPE [NAME_PREFIX | -l label] | TYPE/NAME)"</span>,</span><br><span class="line">        DisableFlagsInUseLine: <span class="literal">true</span>,</span><br><span class="line">        Short:   i18n.T(<span class="string">"Show details of a specific resource or group of resources"</span>),</span><br><span class="line">        Long:    describeLong + <span class="string">"\n\n"</span> + cmdutil.SuggestApiResources(parent),</span><br><span class="line">        Example: describeExample,</span><br><span class="line">        Run: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span></span> &#123;  <span class="comment">// 处理回调函数</span></span><br><span class="line">            cmdutil.CheckErr(o.Complete(f, cmd, args))</span><br><span class="line">            cmdutil.CheckErr(o.Run())</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    usage := <span class="string">"containing the resource to describe"</span></span><br><span class="line">    cmdutil.AddFilenameOptionFlags(cmd, o.FilenameOptions, usage)</span><br><span class="line">    cmd.Flags().StringVarP(&amp;o.Selector, <span class="string">"selector"</span>, <span class="string">"l"</span>, o.Selector, <span class="string">"Selector (label query) to filter on, supports '=', '==', and '!='.(e.g. -l key1=value1,key2=value2)"</span>)</span><br><span class="line">    cmd.Flags().BoolVar(&amp;o.AllNamespaces, <span class="string">"all-namespaces"</span>, o.AllNamespaces, <span class="string">"If present, list the requested object(s) across all namespaces. Namespace in current context is ignored even if specified with --namespace."</span>)</span><br><span class="line">    cmd.Flags().BoolVar(&amp;o.DescriberSettings.ShowEvents, <span class="string">"show-events"</span>, o.DescriberSettings.ShowEvents, <span class="string">"If true, display events related to the described object."</span>)</span><br><span class="line">    cmdutil.AddIncludeUninitializedFlag(cmd)</span><br><span class="line">    <span class="keyword">return</span> cmd</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="func-o-DescribeOptions-Run"><a href="#func-o-DescribeOptions-Run" class="headerlink" title="func (o *DescribeOptions) Run()"></a><code>func (o *DescribeOptions) Run()</code></h2><p><a href="https://github.com/kubernetes/kubernetes/blob/v1.11.7/pkg/kubectl/cmd/describe.go#L156" target="_blank" rel="noopener"><code>kubernetes/pkg/kubectl/cmd/describe.go</code></a><br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(o *DescribeOptions)</span> <span class="title">Run</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    r := o.NewBuilder().</span><br><span class="line">        Unstructured().</span><br><span class="line">        ContinueOnError().</span><br><span class="line">        NamespaceParam(o.Namespace).DefaultNamespace().AllNamespaces(o.AllNamespaces).</span><br><span class="line">        FilenameParam(o.EnforceNamespace, o.FilenameOptions).</span><br><span class="line">        LabelSelectorParam(o.Selector).     <span class="comment">// 设置用户的标签选择</span></span><br><span class="line">        IncludeUninitialized(o.IncludeUninitialized).   </span><br><span class="line">        ResourceTypeOrNameArgs(<span class="literal">true</span>, o.BuilderArgs...).     <span class="comment">// 提取用户选择操作的对象类型</span></span><br><span class="line">        Flatten().  <span class="comment">// 决定以何种方式从Kubernetes的返回数据中提取数据</span></span><br><span class="line">        Do()        <span class="comment">// 执行命令获取数据</span></span><br><span class="line">    err := r.Err()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    allErrs := []error&#123;&#125;</span><br><span class="line">    infos, err := r.Infos()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> apierrors.IsNotFound(err) &amp;&amp; <span class="built_in">len</span>(o.BuilderArgs) == <span class="number">2</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> o.DescribeMatchingResources(err, o.BuilderArgs[<span class="number">0</span>], o.BuilderArgs[<span class="number">1</span>])</span><br><span class="line">        &#125;</span><br><span class="line">        allErrs = <span class="built_in">append</span>(allErrs, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    errs := sets.NewString()</span><br><span class="line">    first := <span class="literal">true</span></span><br><span class="line">    <span class="keyword">for</span> _, info := <span class="keyword">range</span> infos &#123;</span><br><span class="line">        mapping := info.ResourceMapping()</span><br><span class="line">        describer, err := o.Describer(mapping)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> errs.Has(err.Error()) &#123;</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            allErrs = <span class="built_in">append</span>(allErrs, err)</span><br><span class="line">            errs.Insert(err.Error())</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 通过describe方法将提取到的数据打印出来</span></span><br><span class="line">        s, err := describer.Describe(info.Namespace, info.Name, *o.DescriberSettings)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> errs.Has(err.Error()) &#123;</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            allErrs = <span class="built_in">append</span>(allErrs, err)</span><br><span class="line">            errs.Insert(err.Error())</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> first &#123;</span><br><span class="line">            first = <span class="literal">false</span></span><br><span class="line">            fmt.Fprint(o.Out, s)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            fmt.Fprintf(o.Out, <span class="string">"\n\n%s"</span>, s)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> utilerrors.NewAggregate(allErrs)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><code>o.NewBuilder().Unstructured().ContinueOnError().NamespaceParam()....Flatten()</code>该链式调用是为执行命令做准备，然后通过<code>Do()</code>是注册具体向ApiServer请求数据，并将返回数据转化为通用结构。</li>
<li><code>describer.Describe()</code>函数是将提取出的返回函数打印出来做可视化。</li>
</ul>
<h2 id="func-b-Builder-Do"><a href="#func-b-Builder-Do" class="headerlink" title="func (b *Builder) Do()"></a><code>func (b *Builder) Do()</code></h2><p><a href="https://github.com/kubernetes/kubernetes/blob/v1.11.7/pkg/kubectl/genericclioptions/resource/builder.go#L1059" target="_blank" rel="noopener"><code>kubernetes/pkg/kubectl/genericclioptions/resource/builder.go</code></a><br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Do returns a Result object with a Visitor for the resources identified by the Builder.</span></span><br><span class="line"><span class="comment">// The visitor will respect the error behavior specified by ContinueOnError. Note that stream</span></span><br><span class="line"><span class="comment">// inputs are consumed by the first execution - use Infos() or Object() on the Result to capture a list</span></span><br><span class="line"><span class="comment">// for further iteration.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">Do</span><span class="params">()</span> *<span class="title">Result</span></span> &#123;</span><br><span class="line">    r := b.visitorResult()</span><br><span class="line">    r.mapper = b.Mapper()</span><br><span class="line">    <span class="keyword">if</span> r.err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> r</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> b.flatten &#123;</span><br><span class="line">        r.visitor = NewFlattenListVisitor(r.visitor, b.objectTyper, b.mapper)</span><br><span class="line">    &#125;</span><br><span class="line">    helpers := []VisitorFunc&#123;&#125;</span><br><span class="line">    <span class="comment">//  注册获取数据前的动作</span></span><br><span class="line">    <span class="keyword">if</span> b.defaultNamespace &#123;</span><br><span class="line">        helpers = <span class="built_in">append</span>(helpers, SetNamespace(b.namespace))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> b.requireNamespace &#123;</span><br><span class="line">        helpers = <span class="built_in">append</span>(helpers, RequireNamespace(b.namespace))</span><br><span class="line">    &#125;</span><br><span class="line">    helpers = <span class="built_in">append</span>(helpers, FilterNamespace)</span><br><span class="line">    <span class="keyword">if</span> b.requireObject &#123;</span><br><span class="line">        <span class="comment">// 注册从ApiServer获取数据的方法</span></span><br><span class="line">        helpers = <span class="built_in">append</span>(helpers, RetrieveLazy)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 注册从返回数据中提取数据的方法</span></span><br><span class="line">    r.visitor = NewDecoratedVisitor(r.visitor, helpers...)</span><br><span class="line">    <span class="keyword">if</span> b.continueOnError &#123;</span><br><span class="line">        r.visitor = ContinueOnErrorVisitor&#123;r.visitor&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="func-RetrieveLazy-info-Info-err-error"><a href="#func-RetrieveLazy-info-Info-err-error" class="headerlink" title="func RetrieveLazy(info *Info, err error)"></a><code>func RetrieveLazy(info *Info, err error)</code></h2><p><a href="https://github.com/kubernetes/kubernetes/blob/v1.11.7/pkg/kubectl/genericclioptions/resource/vistor.go#L631" target="_blank" rel="noopener"><code>kubernetes/pkg/kubectl/genericclioptions/resource/vistor.go</code></a><br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RetrieveLazy updates the object if it has not been loaded yet.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RetrieveLazy</span><span class="params">(info *Info, err error)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> info.Object == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> info.Get()   <span class="comment">// 从ApiServer获取数据</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="func-NewDecoratedVisitor-v-Visitor-fn-VisitorFunc"><a href="#func-NewDecoratedVisitor-v-Visitor-fn-VisitorFunc" class="headerlink" title="func NewDecoratedVisitor(v Visitor, fn ...VisitorFunc)"></a><code>func NewDecoratedVisitor(v Visitor, fn ...VisitorFunc)</code></h2><p><a href="https://github.com/kubernetes/kubernetes/blob/v1.11.7/pkg/kubectl/genericclioptions/resource/vistor.go#L297" target="_blank" rel="noopener"><code>kubernetes/pkg/kubectl/genericclioptions/resource/vistor.go</code></a><br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewDecoratedVisitor will create a visitor that invokes the provided visitor functions before</span></span><br><span class="line"><span class="comment">// the user supplied visitor function is invoked, giving them the opportunity to mutate the Info</span></span><br><span class="line"><span class="comment">// object or terminate early with an error.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDecoratedVisitor</span><span class="params">(v Visitor, fn ...VisitorFunc)</span> <span class="title">Visitor</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(fn) == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> v</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> DecoratedVisitor&#123;v, fn&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="func-r-Result-Infos"><a href="#func-r-Result-Infos" class="headerlink" title="func (r *Result) Infos()"></a><code>func (r *Result) Infos()</code></h2><p><a href="https://github.com/kubernetes/kubernetes/blob/v1.11.7/pkg/kubectl/genericclioptions/resource/result.go#L113" target="_blank" rel="noopener"><code>kubernetes/pkg/kubectl/genericclioptions/resource/result.go</code></a><br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Infos returns an array of all of the resource infos retrieved via traversal.</span></span><br><span class="line"><span class="comment">// Will attempt to traverse the entire set of visitors only once, and will return</span></span><br><span class="line"><span class="comment">// a cached list on subsequent calls.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Result)</span> <span class="title">Infos</span><span class="params">()</span> <span class="params">([]*Info, error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> r.err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, r.err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> r.info != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> r.info, <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    infos := []*Info&#123;&#125;</span><br><span class="line">    err := r.visitor.Visit(<span class="function"><span class="keyword">func</span><span class="params">(info *Info, err error)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">        infos = <span class="built_in">append</span>(infos, info)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;)</span><br><span class="line">    err = utilerrors.FilterOut(err, r.ignoreErrors...)</span><br><span class="line"></span><br><span class="line">    r.info, r.err = infos, err</span><br><span class="line">    <span class="keyword">return</span> infos, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="func-v-DecoratedVisitor-Visit-fn-VisitorFunc"><a href="#func-v-DecoratedVisitor-Visit-fn-VisitorFunc" class="headerlink" title="func (v DecoratedVisitor) Visit(fn VisitorFunc)"></a><code>func (v DecoratedVisitor) Visit(fn VisitorFunc)</code></h2><p><a href="https://github.com/kubernetes/kubernetes/blob/v1.11.7/pkg/kubectl/genericclioptions/resource/visitor.go#L305" target="_blank" rel="noopener"><code>kubernetes/pkg/kubectl/genericclioptions/resource/visitor.go</code></a><br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Visit implements Visitor</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v DecoratedVisitor)</span> <span class="title">Visit</span><span class="params">(fn VisitorFunc)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> v.visitor.Visit(<span class="function"><span class="keyword">func</span><span class="params">(info *Info, err error)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> i := <span class="keyword">range</span> v.decorators &#123;</span><br><span class="line">            <span class="keyword">if</span> err := v.decorators[i](info, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> err</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fn(info, <span class="literal">nil</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Visitor可以使用户可以将来自ApiServer的数据转化为通用数据集合。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2019/01/30/Kubernetes源码阅读—kubelet(二)/" class="next">NEXT</a></div><div class="copyright"><p>© 2018 - 2019 <a href="http://xizie.com">Bin Xu</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>